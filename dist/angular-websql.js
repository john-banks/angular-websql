"use strict";angular.module("angular-websql",[]).factory("$webSql",["$q",function($q){return{openDatabase:function(dbName,version,desc,size){try{var db=openDatabase(dbName,version,desc,size);if("undefined"==typeof openDatabase)throw"Browser does not support web sql";return{executeQuery:function(query,values){var deferred=$q.defer();return db.transaction(function(tx){try{tx.executeSql(query,values,function(tx,results){deferred.resolve(results)},function(tx,results){console.error(query),console.error(values),console.error(results),deferred.reject(results)})}catch(e){console.log(e)}},function(e){console.log("transaction error"),deferred.reject(e)}),deferred.promise},insert:function(c,e){var f="INSERT INTO `{tableName}` ({fields}) VALUES({values});",a="",b="",v=[];for(var d in e)a+=Object.keys(e)[Object.keys(e).length-1]==d?"`"+d+"`":"`"+d+"`, ",b+=Object.keys(e)[Object.keys(e).length-1]==d?"?":"?, ",v.push(e[d]);return this.executeQuery(this.replace(f,{"{tableName}":c,"{fields}":a,"{values}":b}),v)},update:function(b,g,c){var f="UPDATE `{tableName}` SET {update} WHERE {where}; ",e="",v=[],first=!0;for(var d in g)first?first=!1:e+=",",e+="`"+d+"`= ?",v.push(g[d]);var a=this.whereClause(c);return this.executeQuery(this.replace(f,{"{tableName}":b,"{update}":e,"{where}":a.w}),v.concat(a.p))},del:function(b,c){var d="DELETE FROM `{tableName}` WHERE {where}; ",a=this.whereClause(c);return this.executeQuery(this.replace(d,{"{tableName}":b,"{where}":a.w}),a.p)},select:function(b,c){var d="SELECT * FROM `{tableName}` WHERE {where}; ",a=this.whereClause(c);return this.executeQuery(this.replace(d,{"{tableName}":b,"{where}":a.w}),a.p)},selectAll:function(a){return this.executeQuery("SELECT * FROM `"+a+"`; ",[])},whereClause:function(b){var a="",v=[];if(angular.isArray(b))for(var i=0;i!=b.length;i++){var condition=b[i];if(condition.union?a+=condition.union:0!==i&&(a+=" AND "),a+="`"+condition.column+"` ",a+=condition.operator?condition.operator:"=",angular.isArray(condition.value)){a+="(";for(var j=0;j!=condition.value.length;j++)a+=0!==j?",?":"?",v.push(condition.value[j]);a+=")"}else{var value=String(condition.value);value.match(/NULL/gi)?a+="NULL":(a+="?",v.push(value))}}else for(var c in b)b[c].value&&(b[c].value=String(b[c].value)),"undefined"==typeof b[c]||"object"==typeof b[c]||"string"!=typeof b[c]||b[c].match(/NULL/gi)?"undefined"!=typeof b[c]&&"object"!=typeof b[c]&&"number"==typeof b[c]?v.push(b[c]):"undefined"==typeof b[c].value||"object"!=typeof b[c]||b[c].value.match(/NULL/gi)||v.push(b[c].value):v.push(b[c]),a+="object"==typeof b[c]?"undefined"==typeof b[c].union?"string"==typeof b[c].value&&b[c].value.match(/NULL/gi)?"`"+c+"` "+b[c].value:"`"+c+"` "+b[c].operator+" ? ":"string"==typeof b[c].value&&b[c].value.match(/NULL/gi)?"`"+c+"` "+b[c].value+" "+b[c].union+" ":"`"+c+"` "+b[c].operator+" ? "+b[c].union+" ":"string"==typeof b[c]&&b[c].match(/NULL/gi)?"`"+c+"` "+b[c]:"`"+c+"`=?";return{w:a,p:v}},replace:function(a,c){for(var b in c)a=a.replace(new RegExp(b,"ig"),c[b]);return a},createTable:function(j,g){var b="CREATE TABLE IF NOT EXISTS `{tableName}` ({fields}); ",c=[],a="";for(var e in g){var l="{type} {null}";a+="`"+e+"` ","undefined"==typeof g[e]["null"]&&(g[e]["null"]="NULL");for(var k in g[e])l=l.replace(new RegExp("{"+k+"}","ig"),g[e][k]);a+=l,"undefined"!=typeof g[e]["default"]&&(a+=" DEFAULT "+g[e]["default"]),"undefined"!=typeof g[e].primary&&(a+=" PRIMARY KEY"),"undefined"!=typeof g[e].auto_increment&&(a+=" AUTOINCREMENT"),Object.keys(g)[Object.keys(g).length-1]!=e&&(a+=","),"undefined"!=typeof g[e].primary&&g[e].primary&&c.push(e)}var d={tableName:j,fields:a};for(var f in d)b=b.replace(new RegExp("{"+f+"}","ig"),d[f]);return this.executeQuery(b,[])},dropTable:function(a){return this.executeQuery("DROP TABLE IF EXISTS `"+a+"`; ",[])}}}catch(err){console.error(err)}}}}]);